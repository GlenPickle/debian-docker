From 7b31ed432ee2fa95938d64dc76c982e52cd00330 Mon Sep 17 00:00:00 2001
From: Govinda Fichtner <govinda.fichtner@googlemail.com>
Date: Mon, 23 Nov 2015 20:00:43 +0100
Subject: [PATCH] add support for building first ARM debian package

Signed-off-by: Govinda Fichtner <govinda.fichtner@googlemail.com>
---
 contrib/builder/deb/README.md                      |   5 -
 contrib/builder/deb/amd64/README.md                |   5 +
 contrib/builder/deb/amd64/build.sh                 |  10 ++
 contrib/builder/deb/amd64/debian-jessie/Dockerfile |  15 ++
 .../builder/deb/amd64/debian-stretch/Dockerfile    |  15 ++
 contrib/builder/deb/amd64/debian-wheezy/Dockerfile |  16 ++
 contrib/builder/deb/amd64/generate.sh              | 127 +++++++++++++
 .../builder/deb/amd64/ubuntu-precise/Dockerfile    |  15 ++
 contrib/builder/deb/amd64/ubuntu-trusty/Dockerfile |  15 ++
 contrib/builder/deb/amd64/ubuntu-wily/Dockerfile   |  15 ++
 contrib/builder/deb/armhf/debian-jessie/Dockerfile |  10 ++
 contrib/builder/deb/build.sh                       |  10 --
 contrib/builder/deb/debian-jessie/Dockerfile       |  15 --
 contrib/builder/deb/debian-stretch/Dockerfile      |  15 --
 contrib/builder/deb/debian-wheezy/Dockerfile       |  16 --
 contrib/builder/deb/generate.sh                    | 127 -------------
 contrib/builder/deb/ubuntu-precise/Dockerfile      |  15 --
 contrib/builder/deb/ubuntu-trusty/Dockerfile       |  15 --
 contrib/builder/deb/ubuntu-wily/Dockerfile         |  15 --
 contrib/builder/rpm/README.md                      |   5 -
 contrib/builder/rpm/amd64/README.md                |   5 +
 contrib/builder/rpm/amd64/build.sh                 |  10 ++
 contrib/builder/rpm/amd64/centos-7/Dockerfile      |  18 ++
 contrib/builder/rpm/amd64/fedora-22/Dockerfile     |  38 ++++
 contrib/builder/rpm/amd64/fedora-23/Dockerfile     |  38 ++++
 contrib/builder/rpm/amd64/generate.sh              | 196 +++++++++++++++++++++
 contrib/builder/rpm/amd64/opensuse-13.2/Dockerfile |  17 ++
 contrib/builder/rpm/amd64/oraclelinux-6/Dockerfile |  27 +++
 contrib/builder/rpm/amd64/oraclelinux-7/Dockerfile |  17 ++
 contrib/builder/rpm/build.sh                       |  10 --
 contrib/builder/rpm/centos-7/Dockerfile            |  18 --
 contrib/builder/rpm/fedora-22/Dockerfile           |  38 ----
 contrib/builder/rpm/fedora-23/Dockerfile           |  38 ----
 contrib/builder/rpm/generate.sh                    | 196 ---------------------
 contrib/builder/rpm/opensuse-13.2/Dockerfile       |  17 --
 contrib/builder/rpm/oraclelinux-6/Dockerfile       |  27 ---
 contrib/builder/rpm/oraclelinux-7/Dockerfile       |  17 --
 contrib/reprepro/suites.sh                         |   2 +-
 hack/make/.build-rpm/docker-engine.spec            |   2 +-
 hack/make/.detect-daemon-osarch                    |  16 ++
 hack/make/build-deb                                |   3 +-
 hack/make/build-rpm                                |  11 +-
 hack/make/release-deb                              |   4 +-
 hack/make/release-rpm                              |   2 +-
 hack/make/test-deb-install                         |   2 +-
 project/ARM.md                                     |   5 +-
 46 files changed, 643 insertions(+), 612 deletions(-)
 delete mode 100644 contrib/builder/deb/README.md
 create mode 100644 contrib/builder/deb/amd64/README.md
 create mode 100755 contrib/builder/deb/amd64/build.sh
 create mode 100644 contrib/builder/deb/amd64/debian-jessie/Dockerfile
 create mode 100644 contrib/builder/deb/amd64/debian-stretch/Dockerfile
 create mode 100644 contrib/builder/deb/amd64/debian-wheezy/Dockerfile
 create mode 100755 contrib/builder/deb/amd64/generate.sh
 create mode 100644 contrib/builder/deb/amd64/ubuntu-precise/Dockerfile
 create mode 100644 contrib/builder/deb/amd64/ubuntu-trusty/Dockerfile
 create mode 100644 contrib/builder/deb/amd64/ubuntu-wily/Dockerfile
 create mode 100644 contrib/builder/deb/armhf/debian-jessie/Dockerfile
 delete mode 100755 contrib/builder/deb/build.sh
 delete mode 100644 contrib/builder/deb/debian-jessie/Dockerfile
 delete mode 100644 contrib/builder/deb/debian-stretch/Dockerfile
 delete mode 100644 contrib/builder/deb/debian-wheezy/Dockerfile
 delete mode 100755 contrib/builder/deb/generate.sh
 delete mode 100644 contrib/builder/deb/ubuntu-precise/Dockerfile
 delete mode 100644 contrib/builder/deb/ubuntu-trusty/Dockerfile
 delete mode 100644 contrib/builder/deb/ubuntu-wily/Dockerfile
 delete mode 100644 contrib/builder/rpm/README.md
 create mode 100644 contrib/builder/rpm/amd64/README.md
 create mode 100755 contrib/builder/rpm/amd64/build.sh
 create mode 100644 contrib/builder/rpm/amd64/centos-7/Dockerfile
 create mode 100644 contrib/builder/rpm/amd64/fedora-22/Dockerfile
 create mode 100644 contrib/builder/rpm/amd64/fedora-23/Dockerfile
 create mode 100755 contrib/builder/rpm/amd64/generate.sh
 create mode 100644 contrib/builder/rpm/amd64/opensuse-13.2/Dockerfile
 create mode 100644 contrib/builder/rpm/amd64/oraclelinux-6/Dockerfile
 create mode 100644 contrib/builder/rpm/amd64/oraclelinux-7/Dockerfile
 delete mode 100755 contrib/builder/rpm/build.sh
 delete mode 100644 contrib/builder/rpm/centos-7/Dockerfile
 delete mode 100644 contrib/builder/rpm/fedora-22/Dockerfile
 delete mode 100644 contrib/builder/rpm/fedora-23/Dockerfile
 delete mode 100755 contrib/builder/rpm/generate.sh
 delete mode 100644 contrib/builder/rpm/opensuse-13.2/Dockerfile
 delete mode 100644 contrib/builder/rpm/oraclelinux-6/Dockerfile
 delete mode 100644 contrib/builder/rpm/oraclelinux-7/Dockerfile

diff --git a/hack/make/.detect-daemon-osarch b/hack/make/.detect-daemon-osarch
index f95afc4..5c6d3f5 100644
--- a/hack/make/.detect-daemon-osarch
+++ b/hack/make/.detect-daemon-osarch
@@ -9,6 +9,7 @@ export DOCKER_ENGINE_OSARCH="$(docker version | awk '
 ')"
 export DOCKER_ENGINE_GOOS="${DOCKER_ENGINE_OSARCH%/*}"
 export DOCKER_ENGINE_GOARCH="${DOCKER_ENGINE_OSARCH##*/}"
+DOCKER_ENGINE_GOARCH=${DOCKER_ENGINE_GOARCH:=amd64}
 
 # and the client, just in case
 export DOCKER_CLIENT_OSARCH="$(docker version | awk '
@@ -16,3 +17,18 @@ export DOCKER_CLIENT_OSARCH="$(docker version | awk '
 	$1 == "Server:" { client = 0; next }
 	client && $1 == "OS/Arch:" { print $2 }
 ')"
+
+# Retrieve the architecture used in contrib/builder/(deb|rpm)/$PACKAGE_ARCH/
+PACKAGE_ARCH="amd64"
+case "$DOCKER_ENGINE_OSARCH" in
+	linux/arm)
+		PACKAGE_ARCH='armhf'
+		;;
+	linux/ppc64le)
+		PACKAGE_ARCH='ppc64le'
+		;;
+	linux/s390x)
+		PACKAGE_ARCH='s390x'
+		;;
+esac
+export PACKAGE_ARCH
